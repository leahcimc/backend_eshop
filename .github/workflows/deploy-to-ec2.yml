name: Deploy to EC2

on: # specify the build to trigger the automated ci/cd
   push:
     branches:
           - main
           
jobs:
   deploy:
     runs-on: ubuntu-latest # specify the build machine
     steps:
         - # checkout to the repository on the build machine
             name: Checkout code
             uses: actions/checkout@v3

         - # Set up JDK 17 
             name: Set up JDK 17

         - # Assemble the project with Gradle Wrapper to jar file
             name: Make gradlew executable
 
         - # Login to Docker Hub
             name: Login to Docker Hub
             uses: docker/login-action@v2
             with:
               username: ${{ secrets.DOCKERHUB_USERNAME }}
               password: ${{ secrets.DOCKERHUB_TOKEN }}
 
         - # Build Docker image
             name: Build Docker image
             uses: docker/build-push-action@v4
 
         - # Tag Docker image
             name: Tag Docker image
             uses: docker/build-push-action@v4
             with: 
                context: .
                file: ./Dockerfile
                tags: $/project-backend:latest
 
         - # Push Docker image
             name: Push Docker image
             uses: docker/build-push-action@v4
             with: 
                context: .
                file: ./Dockerfile
                push: true
                tags: $/project-backend:latest
 
         - # SSH into EC2 instance and Docker Pull, Stop, Remove and Run
             name: SSH into EC2 instance
             env:
               PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
               HOSTNAME: ${{secrets.EC2_HOST}}
               USER_NAME: ${{secrets.EC2_USERNAME}}
             run: |
                echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
                ssh -o StrictHostKeyChecking=no -i private_key ${USER_NAME}@${HOSTNAME} '

                    cd /home/ubuntu/<PROJECT_DIRECTORY> &&
                    git checkout dev &&
                    git fetch --all &&
                    git reset --hard origin/dev &&
                    git pull origin dev &&
                    sudo npm i &&
                    sudo npm run build &&
                    sudo pm2 stop ./dist/index.js &&
                    sudo pm2 start ./dist/index.js
